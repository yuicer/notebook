---
title: 手机网页支付
categories:
  - 尺工
date: 2017-09-26 17:55:41
---
<p></p>
<!-- more -->
## 前言
最近做手机网页支付，就微信，支付宝，qq钱包三种支付，把其中踩的坑总结一下。
1. 大概原理
后台向支付平台提交订单获取参数。
通过 js 跳转 app 的带参 url schema ，唤起 app 进行支付。
支付后跳到商品详情页面，查询是否支付成功并显示相应信息。

2. 准备工作
这三种都需要去官方的公众平台去开通相应功能，并设置授权域名
qq 钱包支付使用场景默认在 qq 或 tim 内使用，一般配合 qq 公众号。公众号这个和商户没有关系，只需要将支付网页的链接放到二级域名就可以。

技术文档如下 
[支付宝](https://docs.open.alipay.com/203)
[微信支付](https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=15_4)
[qq钱包](https://qpay.qq.com/qpaywiki/showdocument.php?pid=38&docid=164)

3. 开发流程

### 支付宝
场景：非微信浏览器网页中，辣鸡微信
支付宝做的是最好的一个，无论是文档还是使用流程。该有的都有，实乃业界楷模。
[各种支付模式，应用场景](https://openhome.alipay.com/developmentDocument.htm)
支付宝有额外的沙盒模式，它会为每一个注册的应用分配一个单独的支付宝沙盒版app，付钱可以随意更改。

支付宝的流程也很清楚，商户页点支付，商户后台向支付宝下单并从支付宝那边获得并返回商户页一个 url ，商户页通过 url 跳转到支付宝自己的支付网页，该页面的逻辑是跳转过来后就尝试通过 url schema 去唤起支付宝，同时进行一个 setTimeout 5s，若唤起支付宝，该网页就不需要处理，没唤起支付吧，则会自动出现继续支付和已完成支付两个按钮，点击继续支付会出现网页登录支付宝，然后进行支付的流程，点击完成支付则会弹出提示。当支付完成后，支付宝会自动跳转到商户后台指定页面，商户后台可以配置一个指定的支付后商品详情页面的 url ，用来显示商品支付详情。商品详情的数据需要两个判断，因为是异步的通知，首先判断商户自己的游戏币有没有到账【通过处理支付宝那边的异步通知进行的游戏币增加】，如果没有到账【由于网络原因此时异步通知还未发送】就主动去查询支付宝商户此订单的详情。且商户后台此时可以增加一个查询日志，这样也方便以后出现充值失败的时候寻找原因

如果是在 app 的 webview 中的话，需要对 webview 进行[设置](https://docs.open.alipay.com/203/107091/)

### 微信
场景：非微信浏览器中，微信浏览器中用公众号支付，使用 sdk，辣鸡微信
辣鸡微信的文档很烂，好像最近一年才开通 wap 支付，即非微信浏览器的网页支付。
辣鸡微信基本没有做流程判断，且很多逻辑没有去做。
虽然有同步跳转，但是得自己构造 url 的参数 redirect_url，且无论用户支付成功或失败都会跳转过来，辣鸡。
另外辣鸡微信没有考虑未安装微信的情况，还是会去尝试打开，只不过没反应。然后5s之后就自动跳转到 redirect_url。
这里为了去增加一个提示用户没有安装微信的功能，尝试去用 iframe 去做，代码如下
```
var node = document.createElement("iframe");
		node.style.display = "none";
		node.src = url
		document.body.appendChild(node);
		setTimeout(() => {
			me.set_error('未安装微信客户端')
			document.body.removeChild(node)
		}, 5000)
```
用 iframe 的目的其实就是要即能打开给定的url，又要保持自己对页面的控制器【在自己的页面】，逻辑也很简单，因为目标微信页面会自己去唤醒微信客户端 weixin:// ，【这段代码藏在这个微信页面里，拿不出来，只能用它给定的页面】，下面为了简洁直接把这个页面当作唤醒。5s 内如果唤醒了就直接去客户端那边了，网页这边也不用处理了，5s 还未唤醒那么就默认没有装微信。

这个方法虽然可用，但是5s 的等待时间还是太长了，用户交互的话得加个 loading 图，且由于网络原因无法保证 5s 是个准确的时间，另外无法显示 redirect_url，因为这个页面是在 iframe 中打开的。默认也会在 iframe 中显示，如果这个时候 iframe 节点被删掉，那么这个回调页面就显示不出来。所以最后还是没有用这种方法，没有增加给用户提示未安装客户端的提示，转而在商品详情页面给出支付失败原因的提示。

#### url schema
在这里顺带提一下这个东西，一般 app 安装的时候都会去在手机上设置一个协议【前提是写 app 的时候有设置这个，不过一般都有设置，设置也很简单】如 myapp:// 这个协议，然后通过自己配置参数，实现很多功能，很多 js_bridge 也是通过这个原理来实现 js 和 app 的通信。

js 可以通过打开这种 url ，然后会被系统检测到并打开相应的 app。【不能通过浏览器方式输入打开】
一般都是通过 iframe 或者 a 标签来打开。
如果有安装，就会直接打开。
很多 sdk 其实就是封装了这些 url schema，做了一些判断处理的库，比如下面要说的 qq 支付的sdk。

### qq钱包
这个是只能在 qq 浏览器中，更明确点是在 qq 内的公众号内使用，以前都不知道 qq 还有公众号来着。。
具体流程和微信公众号差不多，并且因为场景的限制，使用情况也不需要考虑那么多。既然在公众号内，那么肯定能调起支付。
具体使用就调 qq 提供的 [sdk](https://open.mobile.qq.com/sdk/qqapi.js?_bid=152) 接口就好，qq 文档写的还是没支付宝好。
具体使用，信息可以通过后端下订单后返回，pub 的那2个是关于公众号的是否关注和提示语。且通过回调函数自己跳到目标网页。
```
mqq.tenpay.pay({
	tokenId: extras.tokenId,
	pubAcc: extras.pubAcc,
	pubAccHint: extras.pubAccHint,
	appInfo: "appid#" + extras.appId + "|bargainor_id#" + extras.bargainorId + "|channel#wallet"
}, function(result, resultCode) {
	if (!resultCode) {
		location.href = '商品详情页'
	} else {
		me.set_error('支付失败');
	}
})
```

## 后端逻辑
通过开通对应支付服务后会给分配一个 id，然后自己配置签名，密钥等，主要就是下单，查单，处理异步通知，打印日志。
